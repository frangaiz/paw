<h1 id="fragmentos-de-código-para-la-práctica-7">Fragmentos de código para la Práctica 7</h1>

<p><strong>Nota</strong>: este fichero tiene formato <a href="https://daringfireball.net/projects/markdown/syntax">markdown</a>. Puedes usar algún plugin de navegador para ver el contenido del fichero de una forma más agradable (ej.: “Markdown Viewer Webext” para Firefox; o “Markdown Viewer” en G. Chrome).</p>

<h2 id="métodos-para-el-ejercicio-de-añadir-un-artículo">Métodos para el ejercicio de añadir un artículo</h2>

<h3 id="anotación-multipartconfig">Anotación <code class="language-plaintext highlighter-rouge">@MultipartConfig</code></h3>
<pre><code class="language-Java">
@MultipartConfig(fileSizeThreshold = 1024 * 1024 * 1,
                 maxFileSize = 1024 * 1024 * 1,
                 maxRequestSize = 1024 * 1024 * 1 + 10 * 1024)


</code></pre>

<h3 id="métodos-auxiliares-para-el-servlet">Métodos auxiliares para el servlet</h3>
<pre><code class="language-Java">
  // Este método necesita que el servlet que lo use tenga definida una variable de clase
  // llamada CONT_FICH:
  private static long CONT_FICH = 0;

  private String getNombreFicheroFoto(Part part) {
    String fn = part.getSubmittedFileName();
	if (fn == null) return null;
    // En los viejos navegadores IE y Edge el nombre del fichero incluye la ruta
    // Por si acaso, la quitamos
    fn = fn.replaceAll("\\\\", "/");
    fn = fn.substring(fn.lastIndexOf("/") + 1); 
    // Devolver el nombre
    return (System.currentTimeMillis()) + "" + (CONT_FICH++) + fn;
  }
  
  // El método podría mejorarse si se declara una variable global BASE_FOTOS ... pero no es fácil
  protected void guardaFoto(Part foto, Articulo art) throws IOException { 
    String BASE_FOTOS = this.getServletContext().getRealPath("/img/fotosElectr")+File.separator;
    if (foto.getSize() &gt; 0) {
      foto.write(BASE_FOTOS + art.getFoto());
      foto.delete();
    }
  }

  /**
   * Realiza las validaciones para los campos del formulario de alta de
   * nuevo artículo
   *
   * @param art objeto paw.model.Articulo con los datos leídos del formulario
   * @param foto objeto Part con el fichero de la foto del artículo
   * @return Una lista de String con mensajes de error correspondientes a las
   *         reglas de validación que no se cumplen
   */
  private List&lt;String&gt; valida(Articulo art, Part foto) {
    List&lt;String&gt; errores = new ArrayList&lt;String&gt;();

    if (UtilesString.isVacia(art.getNombre())
            || UtilesString.isVacia(art.getTipo())
            || UtilesString.isVacia(art.getFabricante())) {
      errores.add("Debes proporcionar valor para todos los campos requeridos");
    }

    if (art.getNombre() != null &amp;&amp; art.getNombre().length() &gt; 50) {
      errores.add("La longitud máxima del nombre son 50 caracteres");
    }

    if (art.getTipo() != null &amp;&amp; art.getTipo().length() &gt; 15) {
      errores.add("La longitud máxima del tipo son 15 caracteres");
    }

    if (art.getFabricante() != null &amp;&amp; art.getFabricante().length() &gt; 11) {
      errores.add("La longitud máxima del fabricante son 15 caracteres");
    }

    if (art.getDescripcion() != null &amp;&amp; art.getDescripcion().length() &gt; 200) {
      errores.add("La longitud máxima de la descripción son 200 caracteres");
    }

    if (art.getFoto() != null &amp;&amp; art.getFoto().length() &gt; 50) {
      errores.add("El nombre de la foto es demasiado largo");
    }

    if (foto.getSize() &gt; 0 &amp;&amp; !foto.getContentType().startsWith("image")) {
      errores.add("El fichero subido debe ser una imagen.");
    }

    if (art.getPvp() &lt;= 0) {
      errores.add("El precio debe ser una cantidad positiva");
    }

    return errores;
  }
  
</code></pre>
